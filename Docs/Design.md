# 設計書: ESC/POS 週間スケジュールプリンター

## 概要
M5サイズの週間スケジュール（リフィル）を生成し、ESC/POSプリンタへ印刷するWindows GUI PowerShellツール。

## システム構成

### 対象環境
- **OS**: Windows (PowerShell 5.1以上)
- **言語**: PowerShell
- **GUI**: Windows Forms
- **ターゲットプリンタ**: ESC/POSコマンド対応のネットワークプリンタ

### 主要コンポーネント
1. GUIフロントエンド（Windows Forms）
2. ESC/POSペイロード生成エンジン
3. ネットワーク印刷モジュール
4. 週間テンプレート生成器
5. ファイル永続化機構

## アーキテクチャ

### 1. DPI対応
```
Per-Monitor v2 DPI Awareness → フォールバック: SetProcessDPIAware()
```
- Windows 10以降の高DPI環境に対応
- P/Invoke経由でネイティブAPI呼び出し

### 2. データフロー
```
[ユーザー入力]
    ↓
[週間テンプレート生成] ←→ [保存ファイル読み込み]
    ↓
[プレビュー表示（編集可能）]
    ↓
[ESC/POSペイロード変換]
    ↓
[TCP/IP送信] → [プリンタ]
    ↓
[印刷内容をファイル保存]
```

## 機能仕様

### 1. 週間スケジュール生成機能
- **開始日**: DateTimePickerで選択（デフォルト: 当週月曜日）
- **週の定義**: 月曜日始まり
- **テンプレート構造**:
  ```
  [空行]
  yyyy-MM-dd(Mon)
  [空行×3]
  [区切り線]
  ...（7日分）
  ```
- **土日の強調表示**: `!!yyyy-MM-dd(Sat)!!` 形式でマークアップ（印刷時に反転表示）

### 2. ESC/POSコマンド生成
#### サポートコマンド
| コマンド | 16進 | 説明 |
|---------|------|------|
| ESC @ | 1B 40 | プリンタ初期化 |
| FS C 1 | 1C 43 01 | 日本語フォント有効化 |
| ESC M 1 | 1B 4D 01 | フォントB（小） |
| ESC 3 n | 1B 33 28 | 行間設定（0x28=40） |
| GS ! 0x11 | 1D 21 11 | 文字サイズ2倍（オプション） |
| GS B 1/0 | 1D 42 01/00 | 反転ON/OFF |
| GS V A 3 | 1D 56 41 03 | 用紙カット（オプション） |

#### マークアップ処理
- `!!テキスト!!`: 反転表示（GS B 1 → テキスト → GS B 0）
- 正規表現: `(?s)!!(.+?)!!` でパース

### 3. ネットワーク印刷
- **プロトコル**: TCP/IP
- **デフォルト接続先**: 172.16.20.31:9100
- **タイムアウト**: 設定可能（デフォルト5秒）
- **非同期接続**: BeginConnect/EndConnectパターン
- **エラーハンドリング**:
  - 接続タイムアウト
  - ストリーム書き込みタイムアウト
  - 自動クリーンアップ（finally句）

### 4. ファイル永続化
- **保存形式**: `m5-weekly-refill-yyyy-MM-dd.bak.txt`
- **エンコーディング**: UTF-8
- **保存タイミング**: 印刷成功時
- **読み込みタイミング**:
  - アプリ起動時（当週分）
  - 週変更時（前週/次週ボタン、週を反映ボタン）

### 5. GUIコンポーネント

#### 設定パネル
| 項目 | タイプ | デフォルト値 | 説明 |
|------|--------|-------------|------|
| IP | TextBox | 172.16.20.31 | プリンタIPアドレス |
| Port | NumericUpDown | 9100 | TCPポート（1-65535） |
| Timeout(s) | NumericUpDown | 5 | 接続タイムアウト（1-60秒） |
| 2倍(拡大) | CheckBox | false | GS ! 0x11を送信 |
| カット | CheckBox | true | GS V A 3を送信 |
| プレビュー編集 | CheckBox | false | TextBox.ReadOnlyトグル |
| マーカー表示 | CheckBox | false | !!マーカーの表示/非表示 |
| 開始日 | DateTimePicker | 当週月曜 | 週の開始日 |

#### 操作ボタン
| ボタン | 機能 |
|--------|------|
| < | 前週へ移動 |
| > | 次週へ移動 |
| 週を反映 | 選択日付で週テンプレート再生成 |
| テンプレ再読込 | プレビューをfixedTextで上書き |
| 印刷 | ESC/POS送信実行 |
| ログクリア | ログテキストクリア |

#### プレビュー
- **フォント**: Consolas 12pt（等幅）
- **編集**: プレビュー編集チェックで有効化
- **表示制御**:
  - マーカー表示OFF時: `!!` を除去して表示
  - マーカー表示ON時: `!!` を含めて表示

#### ログ
- **フォーマット**: `[yyyy-MM-dd HH:mm:ss] メッセージ`
- **フォント**: Consolas 12pt
- **自動スクロール**: AppendTextで下へ

## 文字エンコーディング

### Shift_JIS変換ロジック
```powershell
function Encode-SjisWin([string]$text)
```
1. 改行を`\n`に統一（`\r\n` → `\n`, `\r` → `\n`）
2. 末尾に`\n`を保証
3. Shift_JISバイト配列へ変換

### ESC/POSペイロード構築
```powershell
function Build-EscPosPayload([string]$Text, [bool]$DoubleSize, [bool]$Cut)
```
1. 初期化コマンド列追加
2. テキストをShift_JISエンコード
3. `!!...!!` パターンを検出し反転コマンド挿入
4. オプションコマンド追加（2倍サイズ、カット）

## エラーハンドリング

### 印刷処理
```
try {
    [入力検証]
    [ペイロード生成]
    [TCP送信]
    [ファイル保存]
    → ログ記録（成功）
} catch {
    → ログ記録（失敗）
    → MessageBox表示
}
```

### ファイルI/O
- 読み込みエラー: サイレント失敗（デフォルトテンプレート使用）
- 保存エラー: 警告ログ出力のみ（印刷成功は保持）

## レイアウト設計

### TableLayoutPanel構成
```
Row0: [AutoSize] 設定パネル
Row1: [AutoSize] プレビューラベル
Row2: [55%]      プレビューテキスト
Row3: [AutoSize] ボタンバー + ログラベル
Row4: [45%]      ログテキスト
```

### FlowLayoutPanel（設定パネル）
```
[IP: ____] [Port: ___] [Timeout: __] [□2倍] [☑カット]
[□プレビュー編集] [□マーカー表示] [開始日: ____] [<] [>] [週を反映]
```

## セキュリティ考慮事項
- **実行ポリシー**: `-ExecutionPolicy Bypass`で起動推奨（README記載）
- **ネットワーク**: 信頼されたネットワーク内での使用を想定
- **入力検証**: IP空文字チェック、ポート範囲制限

## 拡張性

### 将来的な機能追加案
- [ ] プリンタプリセット管理
- [ ] 複数週の一括印刷
- [ ] テンプレートカスタマイズ（メモ欄復活など）
- [ ] プレビュー印刷（画像化）
- [ ] USBシリアル接続対応

### 設定の外部化
現在はハードコード:
- デフォルトIP/ポート
- フォント設定
- ESC/POSコマンド列

→ 将来的にJSON/XMLで外部設定化を検討

## テスト観点
1. **DPI環境**: 100%, 125%, 150%, 200%での表示確認
2. **週境界**: 年末年始、2月29日を含む週
3. **ネットワーク**: 接続拒否、タイムアウト、プリンタオフライン
4. **ファイルI/O**: 読み取り専用ファイル、ディスク容量不足
5. **文字エンコード**: 特殊文字（㈱ etc）、絵文字の印刷結果

## 参考資料
- ESC/POSコマンド仕様: プリンタメーカー提供資料
- Windows Forms DPI対応: Microsoft公式ドキュメント
- PowerShell型定義: `Add-Type` リファレンス
